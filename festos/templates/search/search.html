{% extends 'base.html' %}

{% block extra_css %}
<!--[if (!IE)|(gte IE 8)]><!-->
  <link href="{{ STATIC_PREFIX }}visualsearch/css/visualsearch-datauri.css" media="screen" rel="stylesheet" type="text/css" />
<!--<![endif]-->
<!--[if lte IE 7]><!-->
  <link href="{{ STATIC_PREFIX }}visualsearch/css/visualsearch.css" media="screen" rel="stylesheet" type="text/css" />
<!--<![endif]-->
{% endblock %}

{% block extra_js %}
<script src="{{ STATIC_PREFIX }}visualsearch/js/visualsearch.js" type="text/javascript"></script>
<script src="{{ STATIC_PREFIX }}js/json2.js" type="text/javascript"></script>
{% endblock %}

{% block extra_scripts %}
<script type="text/javascript" charset="utf-8">
      $(document).ready(function() {
        window.visualSearch = VS.init({
          container : $('.visual_search'),
          query      : 'text: "elastic"',
          autosearch  : true,
          showFacets : true,
          unquotable : [
            'text',
            'description',
            'notes'
          ],
          callbacks  : {
            search : function(query, searchCollection) {


                  //data: {},
                  //data: searchCollection.toJSON(),
                  //?q="+facets[0]['text']
                  //
                  //url: "http://localhost:8000/search/", //data: {},
//              qdata={}
//              searchCollection.each(function (elem){ 
//                  field = elem.toJSON()
//                  if (field['category'] != 'text')
//                    qdata[field['category']]=field['value']; 
//                  else{
//                    qdata['q']=field['value']; 
//                  }
//                });
//              $.ajax({url: "http://localhost:8000/search/", 
//                      data: qdata,
//                      success:   function(payload){ 
//                          $('#search_query').append(payload)
//                        },
//                      //dataType: 'json',
//                      type: 'GET',});
              url="http://localhost:8000/?"
              searchCollection.each(function (elem){ 
                  field = elem.toJSON()
                  if (field['category'] != 'text')
                    url += field['category']+"="+field['value']+"&"; 
                  else{
                    url += "q="+field['value']+"&"; 
                  }
                });

              window.location = url
            },

            valueMatches : function(category, searchTerm, callback) {
              switch (category) {
              case 'title':
                  callback([
                    {% for title in titles %}
                      '{{ title }}',
                    {% endfor %}
                    ])
                    ;
                  break;
              case 'author':
                  callback([
                    {% for author in authors %}
                      '{{ author }}',
                    {% endfor %}
                    ])
                    ;
                  break;
                case 'source':
                  callback([
                    {% for source in sources %}
                      '{{ source }}',
                    {% endfor %}
                    ])
                    ;
                  break;
              }
            },
            facetMatches : function(callback) {
              callback([
                'text', 'title', 'author', 'source', 'description', 'notes'
              ]);
            }
          }
        });
      });
    </script>

{% endblock %}

{% block content %}
<div class="container">
  <h2>Search</h2>
  <div class="visual_search"></div>

  {% comment %}
  <form class="navbar-search pull-left" method="get" action=".">
    <table>
      {{ form.as_table }}
      <tr>
        <td>&nbsp;</td>
        <td>
          <input type="submit" value="Search">
        </td>
      </tr>
    </table>
  </form>
  {% endcomment %}
</div>

<div id="search_query"></div>

{% if query %}
  
  <h3>Results</h3>

  {% for result in page.object_list %}
    {% if forloop.first %}
      <ul class="media-list">
    {% endif %}


      {% comment %} <!--<a href="{{ result.object.get_absolute_url }}">{{ result.object }}</a>
      <a href="{% url docviewer_viewer_view result.object.id 'demo' %}">{{ result.object }}</a>-->
      <a href="{{ result.object.document.get_absolute_url }}#search/p{{ result.object.page }}/{{query}}">
        {{ result.object.document.title }} {{result.object.page}}
      </a>
      {% endcomment %} 

      {% ifchanged result.object.document.pk %}
        {% if not forloop.first %}
          </div>
        </li>
        {% endif %}
        <li class="media">
          <a class="pull-left" href="{{ result.object.document.get_absolute_url }}#search/p{{ result.object.page }}/{{query}}">
            <img class="media-object" src="{{ result.object.document.get_thumbnail }}">
          </a>

          <div class="media-body">
            <h4 class="media-heading">{{ result.object.document.title }}</h4>
            {{ result.object.document.text|truncatewords:"100" }} 
      {% endifchanged %}


          <!-- Nested pages -->
          <div class="media">
            <a class="pull-left" href="{{ result.object.document.get_absolute_url }}#search/p{{ result.object.page }}/{{query}}">
              <img class="media-object" src="{{ result.object.get_thumbnail }}">
            </a>

            <div class="media-body">
              <h4 class="media-heading">Page {{result.object.page}}</h4>
              {{ result.object.document.text|truncatewords:"100" }} 
            </div>
         </div>



    {% if forloop.last %}
          </div>
        </li>
      </ul>
    {% endif %}
  {% empty %}
    <p>No results found.</p>
  {% endfor %}








  {% if page.has_previous or page.has_next %}
    <div>
      {% if page.has_previous %}
        <a href="?q={{ query }}&amp;page={{ page.previous_page_number }}"> &laquo; Previous </a>
      {% else %}
        &laquo; Previous
      {% endif %}
      |
      {% if page.has_next %}
        <a href="?q={{ query }}&amp;page={{ page.next_page_number }}">Next &raquo;</a>
      {% else %}
        Next &raquo;
      {% endif %}
      
    </div>
  {% endif %}
  </ul>
{% else %}
  {# Show some example queries to run, maybe query syntax, something else? #}
{% endif %}


{% endblock %}
